<!DOCTYPE html>
<html>

<head>
    <title>Culte Sale Widget</title>
    <link rel="stylesheet" href="https://unpkg.com/picnic">
</head>

<body style="margin: 10%;">
    <h1>Buy Now</h1>
    <h2>BUSD Contract: <a href="https://testnet.bscscan.com/address/0xf27A54452068bD575f5fc3c319a2a15A33D3227B">0xf27A54452068bD575f5fc3c319a2a15A33D3227B</a></h2>
    <h2>Sale Contract: <a href="https://testnet.bscscan.com/address/0x428b4c0DBcE70BCfC2Dcf941cB4EB253a6eCfD62">0x428b4c0DBcE70BCfC2Dcf941cB4EB253a6eCfD62</a></h2>
    <form>
        <label><input id="val" type="number" placeholder="Amount to buy"></label>
        <br><br>
        <select id="curr">
            <option>Select currency</option>
            <option value="BUSD">BUSD (Binance USD)</option>
        </select>
        <br><br>
        <button type="button" id="buy" style="width: 100%;">Buy</button>

    </form>
    <script src="https://cdn.ethers.io/scripts/ethers-v4.min.js" charset="utf-8" type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bignumber.js/8.0.2/bignumber.min.js" charset="utf-8" type="text/javascript"></script>
    <script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>
    <script>
        const desiredNetwork = '97' // '1' is the bsc main network ID, 4 is Rinkeby
        const culteSaleAddress = "0x428b4c0DBcE70BCfC2Dcf941cB4EB253a6eCfD62" // UPDATE, this is pointing to Rinkeby
        const busdAddress = "0xf27A54452068bD575f5fc3c319a2a15A33D3227B";

        // Detect whether the current browser is ethereum-compatible,
        // and handle the case where it isn't:
        if (typeof window.ethereum === 'undefined') {
            alert(
                'You need an Ethereum compatible browser, we recommend Metamask (works with your browser of choice) or Opera.'
            )
        } else {

            // In the case the user has MetaMask installed, you can easily
            // ask them to sign in and reveal their accounts:
            ethereum.enable()

                // Remember to handle the case they reject the request:
                .catch(function (reason) {
                    // This shouldn't happen, so you might want to log this...
                    alert('There was an issue signing you in.')
                })

                // In the case they approve the log-in request, you'll receive their accounts:
                .then(function (accounts) {
                    // You also should verify the user is on the correct network:
                    if (ethereum.networkVersion !== desiredNetwork) {
                        alert('This application requires the main network, please switch it in your MetaMask UI.')
                    }
                })
        }

        document.getElementById('buy').addEventListener('click', function () {
            const value = document.getElementById("val").value;
            const curr = document.getElementById("curr").value;

            if (value == 0) {
                alert("Please select an amount to buy.")
                return
            }

            if (curr == "Select currency") {
                alert("Please select a currency.")
                return
            }

            BuyCulte(value, curr, function (err, transaction) {
                if (err) {
                    return alert(`Sorry you weren't able to buy! Please contact us for support.`)
                }

                alert('Thanks for buying!')
            })

        });

        async function BuyCulte(value, currency, callback) {

            let provider = new ethers.providers.Web3Provider(web3.currentProvider);
            var signer = provider.getSigner();
            let account = await signer.getAddress();
            let abi = [
                "function buyCulteWithBusd(uint256 _amount) public"
            ];
            let abiBUSD = [
                "function approve(address spender, uint256 amount) external returns (bool)"
            ];
            let CulteSaleContract = new ethers.Contract(culteSaleAddress, abi, signer);
            let BUSDContract = new ethers.Contract(busdAddress, abiBUSD, signer);

            console.log(await signer.getAddress());
            if(currency == "BUSD") {
                let tx;
                let tx1;
                let receipt;
                try {
                    tx1 = await BUSDContract.approve(culteSaleAddress, Web3.utils.toWei(""+value, "ether"));
                    await tx1.wait(1);
                    tx = await CulteSaleContract.buyCulteWithBusd(Web3.utils.toWei(""+value, "ether"));
                    receipt = await tx.wait(1);
                } catch (err) {
                    console.log(err);
                    alert(err.data.message);
                }
                if (receipt.status == 1) alert("Purchase confirmed, thank you!")
            }
        }

        function numberWithoutDecimal(num) {
            return parseInt((''+num).replace('.',''));
        }

        function decimalPlaces(num) {
            var match = (''+num).match(/(?:\.(\d+))?(?:[eE]([+-]?\d+))?$/);
            if (!match) { return 0; }
            return Math.max(
                0,
                // Number of digits right of decimal point.
                (match[1] ? match[1].length : 0)
                // Adjust for scientific notation.
                - (match[2] ? +match[2] : 0));
        }
    </script>
</body>

</html>